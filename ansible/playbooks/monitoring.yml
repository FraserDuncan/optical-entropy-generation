---
- name: Deploy monitoring stack
  hosts: monitoring
  become: true
  gather_facts: true

  vars:
    prometheus_version: "2.48.0"
    grafana_version: "10.2.0"
    alertmanager_version: "0.26.0"
    monitoring_base_dir: /opt/monitoring
    prometheus_data_dir: /var/lib/prometheus
    grafana_data_dir: /var/lib/grafana
    alertmanager_data_dir: /var/lib/alertmanager
    prometheus_retention_time: "30d"
    prometheus_retention_size: "10GB"

  pre_tasks:
    - name: Ensure monitoring base directory exists
      ansible.builtin.file:
        path: "{{ monitoring_base_dir }}"
        state: directory
        mode: '0755'

    - name: Install common dependencies
      ansible.builtin.apt:
        name:
          - curl
          - tar
          - gzip
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

  roles:
    - role: prometheus
      tags: [prometheus]

    - role: alertmanager
      tags: [alertmanager]

    - role: grafana
      tags: [grafana]

  post_tasks:
    - name: Display access information
      ansible.builtin.debug:
        msg: |
          Monitoring stack deployed.

          - Prometheus: http://{{ ansible_host }}:9091
          - Grafana: http://{{ ansible_host }}:3000 (admin/admin)
          - Alertmanager: http://{{ ansible_host }}:9093


- name: Deploy entropy exporter
  hosts: entropy_generators
  become: true
  gather_facts: true

  vars:
    entropy_exporter_port: 9090
    rust_features: "metrics"

  roles:
    - role: entropy-exporter
      tags: [exporter]
